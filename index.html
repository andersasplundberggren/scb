<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karlskoga – folkmängd (SCB)</title>
  <meta name="theme-color" content="#0B1220"/>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 2rem; background: #f6f7fb; }
    .card { max-width: 760px; margin: 0 auto; padding: 1.25rem 1.5rem; border: 1px solid rgba(0,0,0,.12); border-radius: 14px; background: #fff; }
    h1 { margin: 0 0 .5rem 0; font-size: clamp(1.4rem, 3vw, 1.8rem); }
    .value { font-size: clamp(2rem, 7vw, 3.4rem); font-weight: 800; margin: .25rem 0 .5rem; letter-spacing: .02em; }
    .meta { color: #666; font-size: .95rem; }
    .small { font-size: .9rem; }
    .error { color: #b00020; white-space: pre-wrap; margin-top: .75rem; }
    details { margin-top: 1rem; }
    a { color: inherit; text-decoration: underline; }
    @media (prefers-color-scheme: dark) {
      body { background: #0b1220; color: #e6e8ee; }
      .card { background: #111a2c; border-color: rgba(255,255,255,.12); }
      .meta { color: #aeb6c2; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Folkmängd i Karlskoga</h1>
    <div id="value" class="value">Hämtar…</div>
    <div id="meta" class="meta small"></div>

    <details>
      <summary>Källa & tekniska detaljer</summary>
      <div class="small" style="margin-top:.5rem; line-height:1.55;">
        Region: <strong>1883 (Karlskoga)</strong><br/>
        Tabell: <code>BE/BE0101/BE0101A/BefolkningNy</code><br/>
        Urval: Kön = 1+2 (totalt), Ålder = totalt, Tid = senaste år<br/>
        Data läses från <code>./data/scb/BE0101/folkmangd_latest.json</code> som uppdateras av GitHub Actions.<br/>
        Statistikdatabasen: <a href="https://www.statistikdatabasen.scb.se/" target="_blank" rel="noreferrer">SCB – Statistikdatabasen</a>
      </div>
    </details>

    <div id="error" class="error" aria-live="polite"></div>
  </div>

  <script>
    function fmtInt(x){ try { return new Intl.NumberFormat('sv-SE').format(x); } catch { return String(x); } }

    async function loadLocalPopulation() {
      const res = await fetch("./data/scb/BE0101/folkmangd_latest.json", { cache: "no-store" });
      if (!res.ok) {
        throw new Error(
          res.status === 404
            ? "Datafil saknas (404). Kör Actions → 'Fetch SCB data' först så genereras filen."
            : `Kunde inte läsa datafilen (${res.status} ${res.statusText})`
        );
      }
      return await res.json();
    }

    (async () => {
      const $value = document.getElementById('value');
      const $meta  = document.getElementById('meta');
      const $error = document.getElementById('error');

      try {
        const json = await loadLocalPopulation();

        // PxWeb JSON: json.data[0].values[0] = talet, json.data[0].key[3] = "Tid" (år)
        const row = json?.data?.[0];
        if (!row) throw new Error("Inget data returnerades från SCB.");

        const value = parseInt(row.values?.[0], 10);
        const year  = (row.key && row.key[row.key.length - 1]) || ""; // sista nyckeln är normalt Tid
        const updated = json?.updated || ""; // finns ibland

        if (!Number.isFinite(value)) throw new Error("Värdet kunde inte tolkas som heltal.");

        $value.textContent = `${fmtInt(value)} invånare`;
        $meta.textContent = [
          year ? `Senaste år: ${year}` : null,
          updated ? `Uppdaterad: ${updated}` : null,
          "Källa: SCB"
        ].filter(Boolean).join(" · ");

      } catch (err) {
        console.error(err);
        $value.textContent = "—";
        $error.textContent = String(err?.message || err);
      }
    })();
  </script>
</body>
</html>
