<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karlskoga ‚Äì Befolkning (SCB)</title>
  <meta name="theme-color" content="#0B1220"/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3Eüìä%3C/text%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 2rem; background: #f6f7fb; }
    .wrap { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 1rem; }
    .card { padding: 1rem 1.25rem; border: 1px solid rgba(0,0,0,.12); border-radius: 14px; background: #fff; }
    h1 { margin: 0 0 .5rem 0; font-size: clamp(1.4rem, 3vw, 1.8rem); }
    .row { display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; }
    label { font-weight: 600; margin-right: .35rem; }
    select, button { padding: .5rem .6rem; border-radius: 10px; border: 1px solid rgba(0,0,0,.2); background: #fff; }
    button { cursor: pointer; }
    .big { font-size: clamp(1.8rem, 6vw, 3rem); font-weight: 800; letter-spacing: .02em; }
    .meta { color: #666; font-size: .95rem; }
    .error { color: #b00020; white-space: pre-wrap; }
    details { margin-top: .5rem; }
    pre { background:#f2f4f8; padding:.5rem; border-radius: 8px; overflow:auto; }
    @media (prefers-color-scheme: dark) {
      body { background: #0b1220; color: #e6e8ee; }
      .card { background: #111a2c; border-color: rgba(255,255,255,.12); }
      select, button { background: #111a2c; color: #e6e8ee; border-color: rgba(255,255,255,.2); }
      .meta { color: #aeb6c2; }
      pre { background: #0f1729; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Befolkning i Karlskoga ‚Äì interaktiv</h1>
    <div class="row">
      <div>
        <label for="months">Tidsomf√•ng:</label>
        <select id="months">
          <option value="12">12 m√•nader</option>
          <option value="24">24 m√•nader</option>
          <option value="60">5 √•r (60 m√•n)</option>
          <option value="120">10 √•r (120 m√•n)</option>
        </select>
      </div>
      <div>
        <label for="sexView">K√∂nsvy:</label>
        <select id="sexView">
          <option value="total">Totalt (m√§n+kvinnor)</option>
          <option value="both">M√§n & kvinnor (separata serier)</option>
          <option value="men">Endast m√§n</option>
          <option value="women">Endast kvinnor</option>
        </select>
      </div>
      <div>
        <label for="chartType">Diagram:</label>
        <select id="chartType">
          <option value="line">Linjediagram</option>
          <option value="stacked">Staplad area (m√§n+kvinnor)</option>
        </select>
      </div>
      <div>
        <button id="refreshBtn">Uppdatera</button>
        <button id="downloadBtn" title="Ladda ned r√•-JSON">Ladda ned JSON</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div id="headline" class="big">‚Äî</div>
    <div id="meta" class="meta"></div>
    <canvas id="chart" height="120"></canvas>
    <div id="error" class="error" style="margin-top:.5rem;"></div>

    <details>
      <summary>K√§lla & detaljer</summary>
      <div class="meta">
        K√§lla: SCB ‚Äì <em>Population per month by region, age and sex</em><br/>
        Tabeller: <code>BefolkManadCKM</code> (2025‚Äì) och <code>BefolkManad</code> (2000‚Äì2024).<br/>
        Region: <strong>1883 (Karlskoga)</strong>, √Ölder: <code>tot</code>, K√∂n: <code>1</code>=m√§n, <code>2</code>=kvinnor.
      </div>
      <div style="margin-top:.5rem;">
        <code id="pxUrl"></code>
      </div>
      <details style="margin-top:.5rem;">
        <summary>Debug JSON</summary>
        <pre id="debug"></pre>
      </details>
    </details>
  </div>
</div>

<script>
  // === 1) S√§tt din Apps Script URL h√§r (slutar p√• /exec) ===
  const PROXY_URL = "https://script.google.com/macros/s/AKfycbwWVf5T4d-JJwbX0alOhs9bCDZwGolqClKoRpztXBvZhcv8LhzfUl_jtS7wE2vICAM/exec";

  // === 2) SCB paths ===
  const PATH_CKM = "BE/BE0101/BE0101A/BefolkManadCKM"; // 2025‚Äì
  const PATH_OLD = "BE/BE0101/BE0101A/BefolkManad";    // 2000‚Äì2024

  // === 3) Urvalskoder ===
  const REGION = "1883";            // Karlskoga
  const AGE = "tot";                // total √•lder
  const SEX_MEN = "1", SEX_WOMEN = "2";

  // UI refs
  const $months   = document.getElementById('months');
  const $sexView  = document.getElementById('sexView');
  const $chartType= document.getElementById('chartType');
  const $btn      = document.getElementById('refreshBtn');
  const $download = document.getElementById('downloadBtn');
  const $headline = document.getElementById('headline');
  const $meta     = document.getElementById('meta');
  const $debug    = document.getElementById('debug');
  const $pxUrl    = document.getElementById('pxUrl');
  const $err      = document.getElementById('error');

  const fmtInt = (x) => { try { return new Intl.NumberFormat('sv-SE').format(x); } catch { return String(x); } };

  // Bygg en PxWeb-body UTAN ContentsCode (tabellen har bara ett m√•tt)
  function buildBody(monthCount) {
    return {
      query: [
        { code: 'Region', selection: { filter: 'item', values: [REGION] } },
        { code: 'Alder',  selection: { filter: 'item', values: [AGE] } },
        { code: 'Kon',    selection: { filter: 'item', values: [SEX_MEN, SEX_WOMEN] } },
        { code: 'Tid',    selection: { filter: 'top',  values: [String(monthCount)] } }
      ],
      response: { format: 'JSON' }
    };
  }

  async function scbFetch(path, bodyObj) {
    const url = PROXY_URL + "?path=" + encodeURIComponent(path) + "&body=" + encodeURIComponent(JSON.stringify(bodyObj));
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`Proxy ${res.status} ${res.statusText}`);
    const j = await res.json();
    if (j && j.error) throw new Error((j.status ? `[${j.status}] ` : '') + (j.error || 'Ok√§nt fel') + (j.scbText ? `\n\nSCB: ${j.scbText}` : ''));
    return j;
  }

  // Extrahera period (Tid), m√§n/kvinnor, total ‚Äì robust f√∂r olika kolumnnamn
  function shapeMonthly(json) {
    if (!json?.data?.length) return { labels:[], men:[], women:[] };
    const idx = {};
    (json.columns || []).forEach((c, i) => { idx[c.code] = i; });
    const map = new Map(); // period -> { men, women }
    for (const r of json.data) {
      const keys = r.key || [];
      const period = idx['Tid'] !== undefined ? keys[idx['Tid']] : keys[keys.length-1];
      const sex    = idx['Kon'] !== undefined ? keys[idx['Kon']] : (keys.find(k => k==='1' || k==='2') || '');
      const val    = parseInt(r.values?.[0], 10);
      if (!map.has(period)) map.set(period, { men: 0, women: 0 });
      if (sex === '1' && Number.isFinite(val)) map.get(period).men = val;
      if (sex === '2' && Number.isFinite(val)) map.get(period).women = val;
    }
    const labels = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));
    const men = labels.map(p => map.get(p).men || 0);
    const women = labels.map(p => map.get(p).women || 0);
    return { labels, men, women };
  }

  // H√§mta ‚Äúmonths‚Äù m√•nader genom att kombinera CKM (ny) + legacy (gammal)
  async function fetchCombinedMonths(months) {
    const body = buildBody(months);

    // 1) F√∂rs√∂k h√§mta allt fr√•n CKM
    let usedPaths = [];
    try {
      const ckm = await scbFetch(PATH_CKM, body);
      usedPaths.push(PATH_CKM);
      let shaped = shapeMonthly(ckm);
      // Om CKM har f√§rre m√•nader √§n vi vill ha ‚Üí komplettera fr√•n legacy
      let need = months - shaped.labels.length;
      if (need > 0) {
        const legacy = await scbFetch(PATH_OLD, buildBody(need));
        usedPaths.push(PATH_OLD);
        const oldShaped = shapeMonthly(legacy);
        // sl√• ihop: √§ldre m√•nader f√∂re nyare
        const labels = [...oldShaped.labels, ...shaped.labels];
        const men    = [...oldShaped.men,    ...shaped.men   ];
        const women  = [...oldShaped.women,  ...shaped.women ];
        return { labels, men, women, usedPaths, raw: { ckm, legacy } };
      }
      return { ...shaped, usedPaths, raw: { ckm } };
    } catch (e) {
      // 2) CKM misslyckades ‚Üí h√§mta allt fr√•n legacy (passar om man bara tittar bak√•t)
      const legacy = await scbFetch(PATH_OLD, body);
      usedPaths.push(PATH_OLD);
      const shaped = shapeMonthly(legacy);
      return { ...shaped, usedPaths, raw: { legacy } };
    }
  }

  // Chart.js
  let chart;
  function renderChart({ labels, men, women }, mode, chartType) {
    const ctx = document.getElementById('chart').getContext('2d');
    if (chart) { chart.destroy(); chart = null; }

    const total = labels.map((_, i) => (men[i]||0) + (women[i]||0));

    let datasets = [];
    if (mode === 'both') {
      datasets = [
        { label: 'M√§n', data: men, tension: 0.15, fill: chartType==='stacked' ? 'origin' : false },
        { label: 'Kvinnor', data: women, tension: 0.15, fill: chartType==='stacked' ? 'origin' : false }
      ];
    } else if (mode === 'men') {
      datasets = [{ label: 'M√§n', data: men, tension: 0.15, fill: false }];
    } else if (mode === 'women') {
      datasets = [{ label: 'Kvinnor', data: women, tension: 0.15, fill: false }];
    } else {
      datasets = [{ label: 'Totalt', data: total, tension: 0.15, fill: false }];
    }

    const stacked = (chartType === 'stacked' && mode === 'both');

    chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked,
        plugins: {
          legend: { display: true },
          tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${fmtInt(c.parsed.y)}` } }
        },
        scales: {
          x: { title: { display: true, text: 'M√•nad (YYYYMM)' } },
          y: { title: { display: true, text: 'Inv√•nare' }, ticks: { callback: v => fmtInt(v) } }
        }
      }
    });

    return { total };
  }

  async function refresh() {
    $err.textContent = '';
    $debug.textContent = '';
    $headline.textContent = 'H√§mtar‚Ä¶';
    $meta.textContent = '';

    const months = parseInt($months.value, 10);
    try {
      const combined = await fetchCombinedMonths(months);
      const { labels, men, women, usedPaths, raw } = combined;
      const { total } = renderChart({ labels, men, women }, $sexView.value, $chartType.value);

      // headline & meta
      const lastIdx = labels.length - 1;
      const lastPeriod = labels[lastIdx] || '';
      const lastTotal  = (men[lastIdx]||0) + (women[lastIdx]||0);

      $headline.textContent = `${fmtInt(lastTotal)} inv√•nare (senaste: ${lastPeriod})`;
      $meta.textContent = [
        `Region: 1883 (Karlskoga)`,
        `Tabeller: ${usedPaths.join(' + ')}`,
        `√Ölder: tot`,
        $sexView.value === 'both' ? `Visar M√§n & Kvinnor` :
          $sexView.value === 'men' ? `Endast m√§n` :
          $sexView.value === 'women' ? `Endast kvinnor` : `Totalt`
      ].join(' ¬∑ ');

      // visa exakt query body/path
      const bodyShown = buildBody(months);
      $pxUrl.textContent = `PxWeb paths: ${usedPaths.join(' | ')}  |  BODY: ${JSON.stringify(bodyShown)}`;
      $debug.textContent = JSON.stringify(raw, null, 2);

      // Ladda ned sammanslagen "r√•" data
      $download.onclick = () => {
        const payload = { labels, men, women, total: labels.map((_,i)=> (men[i]||0)+(women[i]||0)), usedPaths };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `scb_befolkning_karlskoga_${months}m.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      };

    } catch (err) {
      console.error(err);
      $headline.textContent = '‚Äî';
      $err.textContent = String(err?.message || err);
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', refresh);
  document.getElementById('months').addEventListener('change', refresh);
  document.getElementById('sexView').addEventListener('change', refresh);
  document.getElementById('chartType').addEventListener('change', refresh);

  refresh();
</script>
</body>
</html>
